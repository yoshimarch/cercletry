<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>円の多角形けんきゅう記録アプリ</title>
  <style>
    body {
      font-family: "ヒラギノ丸ゴ Pro W4", "ヒラギノ丸ゴ Pro", "Hiragino Maru Gothic Pro", "メイリオ", Meiryo, "MS Pゴシック", "MS PGothic", sans-serif;
      background-color: #f0f8ff;
      margin: 0;
      padding: 20px;
      font-size: 16px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      text-align: center;
      color: #ff6b6b;
      margin-bottom: 20px;
      font-size: 28px;
    }
    
    h2 {
      color: #5f27cd;
      margin-top: 20px;
      font-size: 22px;
      text-align: center;
    }
    
    .form-area {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      justify-content: center;
      background-color: #f1f2f6;
      padding: 15px;
      border-radius: 10px;
    }
    
    .control-area {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin: 20px 0;
      justify-content: center;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 18px;
    }
    
    input[type="number"], select {
      padding: 10px;
      font-size: 18px;
      border: 2px solid #ddd;
      border-radius: 8px;
      width: 100px;
    }

    input[type="range"] {
      width: 300px;
    }
    
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 12px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 18px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }
    
    button.blue {
      background-color: #1e90ff;
    }
    
    button.purple {
      background-color: #9c88ff;
    }
    
    button.orange {
      background-color: #ffa502;
    }
    
    button.gray {
      background-color: #8395a7;
    }

    button.red {
      background-color: #ff6b6b;
    }

    button.pink {
      background-color: #fd79a8;
    }

    button.yellow {
      background-color: #feca57;
    }
    
    .canvas-container {
      position: relative;
      width: 800px;
      height: 600px;
      margin: 20px auto;
      border: 2px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      background-color: #f8f9fa;
    }
    
    .result {
      margin: 20px 0;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      background-color: #f8f9fa;
    }
    
    .results-area {
      display: flex;
      margin-top: 30px;
      gap: 20px;
      flex-direction: column;
    }
    
    .legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 15px 0;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      margin: 5px 0;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      border-radius: 4px;
    }

    .animation-controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    .step-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    .status-text {
      text-align: center;
      font-size: 18px;
      margin: 10px 0;
      height: 30px;
    }

    .info-panel {
      margin-top: 20px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      background-color: #f8f9fa;
    }

    .info-title {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .info-content {
      line-height: 1.6;
    }

    .area-display {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .area-box {
      padding: 10px 20px;
      border: 2px solid #ddd;
      border-radius: 10px;
      background-color: white;
      font-size: 18px;
      font-weight: bold;
      min-width: 200px;
      text-align: center;
    }

    .toggle-button {
      display: inline-block;
      padding: 5px 15px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 20px;
      cursor: pointer;
      margin: 0 5px;
      font-size: 14px;
    }

    .toggle-button.active {
      background-color: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }

    .view-mode {
      display: flex;
      justify-content: center;
      margin: 15px 0;
    }

    .step-counter {
      text-align: center;
      font-size: 16px;
      margin-top: 10px;
    }

    /* 記録関連のスタイル */
    .records-container {
      margin-top: 40px;
      padding: 20px;
      border: 2px solid #ddd;
      border-radius: 10px;
      background-color: #f8f9fa;
    }

    .records-title {
      font-size: 24px;
      color: #5f27cd;
      text-align: center;
      margin-bottom: 20px;
    }

    .records-subtitle {
      font-size: 20px;
      color: #ff6b6b;
      margin: 15px 0;
      text-align: center;
    }

    .records-table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      background-color: white;
    }

    .records-table th, .records-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    .records-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    .records-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    .records-table tr:hover {
      background-color: #f1f1f1;
    }

    .records-table .blue-text {
      color: blue;
      font-weight: bold;
    }

    .records-table .red-text {
      color: red;
      font-weight: bold;
    }

    .records-table .green-text {
      color: green;
      font-weight: bold;
    }

    .records-graph-container {
      width: 100%;
      height: 400px;
      margin: 20px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: white;
    }

    .screenshot-area {
      margin-top: 20px;
      text-align: center;
    }

    #recordsSection {
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .tab-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* スクリーンショット用のスタイル */
    @media print {
      body * {
        visibility: hidden;
      }
      #recordsSection, #recordsSection * {
        visibility: visible;
      }
      #recordsSection {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
    
    /* アニメーション速度スライダー */
    .slider-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>円の多角形けんきゅう記録アプリ</h1>
    
    <div class="form-area">
      <div class="form-group">
        <label for="radius">円のおおきさ:</label>
        <input type="number" id="radius" min="1" max="50" value="10" step="1">
      </div>
      
      <div class="form-group">
        <label for="sides">かどの数:</label>
        <select id="sides">
          <!-- JavaScript で追加 -->
        </select>
      </div>
      
      <div class="form-group">
        <label>&nbsp;</label>
        <button id="set-params" class="blue">せっていする</button>
      </div>
    </div>

    <div class="view-mode">
      <button id="toggle-inside" class="toggle-button active">円のなかの形</button>
      <button id="toggle-outside" class="toggle-button active">円のそとの形</button>
    </div>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background-color: rgba(0, 0, 255, 0.3); border: 2px solid blue;"></div>
        <span>円のなかの形</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: rgba(255, 0, 0, 0.3); border: 2px solid red;"></div>
        <span>円のそとの形</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: rgba(0, 255, 0, 0.1); border: 2px solid green;"></div>
        <span>円</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: rgba(255, 165, 0, 0.5); border: 2px solid orange;"></div>
        <span>三角形</span>
      </div>
    </div>
    
    <div class="canvas-container">
      <canvas id="animation-canvas" width="800" height="600"></canvas>
    </div>

    <div class="status-text" id="status-text"></div>

    <div class="step-counter" id="step-counter"></div>

    <div class="control-area">
      <div class="slider-container">
        <span>アニメーションの速さ:</span>
        <input type="range" id="speed-slider" min="1" max="10" value="5">
        <span id="speed-value">ふつう</span>
      </div>
    </div>

    <div class="control-area">
      <div class="form-group">
        <button id="next-step" class="blue">つぎへ</button>
      </div>
      <div class="form-group">
        <button id="play-animation" class="pink">アニメーションさいせい</button>
      </div>
      <div class="form-group">
        <button id="pause-animation" class="orange">ていし</button>
      </div>
      <div class="form-group">
        <button id="add-record" class="green">けっかをきろくする</button>
      </div>
    </div>
    
    <div class="area-display">
      <div class="area-box">
        <span>円のなかの形のめんせき:</span><br>
        <span id="inside-area" class="blue-text">0</span>
      </div>
      <div class="area-box">
        <span>円のそとの形のめんせき:</span><br>
        <span id="outside-area" class="red-text">0</span>
      </div>
      <div class="area-box">
        <span>円のめんせき:</span><br>
        <span id="circle-area" class="green-text">0</span>
      </div>
    </div>

    <!-- 記録セクション -->
    <div id="recordsSection" class="records-container">
      <h2 class="records-title">あなたのしらべたけっか</h2>
      <div class="records-subtitle">R = <span id="record-radius">10</span></div>

      <div class="tab-buttons">
        <button id="table-tab" class="toggle-button active">ひょう</button>
        <button id="graph-tab" class="toggle-button">グラフ</button>
      </div>

      <div id="table-content" class="tab-content active">
        <table class="records-table" id="records-table">
          <thead>
            <tr>
              <th>かどの数</th>
              <th>円のなかの形</th>
              <th>円のそとの形</th>
              <th>まるとのちがい（なか）</th>
              <th>まるとのちがい（そと）</th>
            </tr>
          </thead>
          <tbody>
            <!-- JavaScriptで追加 -->
          </tbody>
        </table>
      </div>

      <div id="graph-content" class="tab-content">
        <div class="records-graph-container">
          <canvas id="records-graph" width="800" height="400"></canvas>
        </div>
      </div>

      <div class="screenshot-area">
        <button id="screenshot-button" class="yellow">けっかをスクショする</button>
        <p>（このボタンを押すと、上のひょうとグラフを画像として保存できます）</p>
      </div>
    </div>

    <div class="info-panel">
      <div class="info-title">三角形で考えるとは？</div>
      <div class="info-content">
        <p>この図では、円のなかの形（内接多角形）と円のそとの形（外接多角形）を、真ん中から三角形に分けて考えています。</p>
        <p>かどの数が増えるほど、これらの形は円に近づいていきます。とても昔の人は、この方法で円の面積を計算していました。</p>
        <p>「つぎへ」ボタンを押すと、どのように三角形に分けるのかを見ることができます。「アニメーションさいせい」ボタンを押すと、自動的に進んでいきます。</p>
        <p>いろいろなかどの数で試して、「けっかをきろくする」ボタンを押すと、その結果をひょうやグラフに記録できます。</p>
      </div>
    </div>
    
    <div style="text-align: center; margin-top: 20px;">
      <button id="show-help">あそびかた</button>
    </div>
  </div>
  
  <script>
    // 定数
    const PI = Math.PI;
    
    // DOM要素
    const radiusInput = document.getElementById('radius');
    const sidesSelect = document.getElementById('sides');
    const setParamsButton = document.getElementById('set-params');
    const animationCanvas = document.getElementById('animation-canvas');
    const nextStepButton = document.getElementById('next-step');
    const playAnimationButton = document.getElementById('play-animation');
    const pauseAnimationButton = document.getElementById('pause-animation');
    const speedSlider = document.getElementById('speed-slider');
    const speedValue = document.getElementById('speed-value');
    const statusText = document.getElementById('status-text');
    const stepCounter = document.getElementById('step-counter');
    const toggleInsideButton = document.getElementById('toggle-inside');
    const toggleOutsideButton = document.getElementById('toggle-outside');
    const insideAreaDisplay = document.getElementById('inside-area');
    const outsideAreaDisplay = document.getElementById('outside-area');
    const circleAreaDisplay = document.getElementById('circle-area');
    const showHelpButton = document.getElementById('show-help');
    const addRecordButton = document.getElementById('add-record');
    const recordsTable = document.getElementById('records-table').querySelector('tbody');
    const recordsGraph = document.getElementById('records-graph');
    const recordRadiusSpan = document.getElementById('record-radius');
    const screenshotButton = document.getElementById('screenshot-button');
    const tableTabButton = document.getElementById('table-tab');
    const graphTabButton = document.getElementById('graph-tab');
    const tableContent = document.getElementById('table-content');
    const graphContent = document.getElementById('graph-content');

    // アニメーション状態
    let radius = 10;
    let sides = 6;
    let displayRadius = 200; // 表示用の半径
    let centerX = animationCanvas.width / 2;
    let centerY = animationCanvas.height / 2;
    let animationSpeed = 5;
    let animationFrame = 0;
    let maxAnimationFrames = 60;
    let animationInterval = null;
    let animationStep = 0;
    let totalSteps = 0;
    let showInside = true;
    let showOutside = true;
    
    // 面積計算結果
    let circleArea = 0;
    let inscribedArea = 0;
    let circumscribedArea = 0;

    // 記録データ
    let records = [];
    
    // かくすうオプションの初期化
    function initSidesOptions() {
      for (let i = 3; i <= 24; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i + 'かく';
        sidesSelect.appendChild(option);
      }
      sidesSelect.value = sides;
    }

    // 多角形の頂点座標を計算
    function calculatePolygonPoints(sides, radius, isInscribed = true) {
      const points = [];
      const angleStep = (2 * Math.PI) / sides;
      const factor = isInscribed ? 1 : 1 / Math.cos(Math.PI / sides);
      
      for (let i = 0; i < sides; i++) {
        const angle = i * angleStep;
        const x = centerX + factor * radius * Math.cos(angle);
        const y = centerY + factor * radius * Math.sin(angle);
        points.push({ x, y });
      }
      
      return points;
    }

    // 面積を計算
    function calculateAreas() {
      // 円の面積
      circleArea = PI * radius * radius;
      
      // 内接多角形の面積
      inscribedArea = (sides / 2) * radius * radius * Math.sin((2 * PI) / sides);
      
      // 外接多角形の面積
      circumscribedArea = sides * radius * radius * Math.tan(PI / sides);
      
      // 表示を更新
      insideAreaDisplay.textContent = inscribedArea.toFixed(4);
      outsideAreaDisplay.textContent = circumscribedArea.toFixed(4);
      circleAreaDisplay.textContent = circleArea.toFixed(4);
    }

    // キャンバスをクリア
    function clearCanvas() {
      const ctx = animationCanvas.getContext('2d');
      ctx.clearRect(0, 0, animationCanvas.width, animationCanvas.height);
    }

    // 背景の円と格子を描画
    function drawBackground() {
      const ctx = animationCanvas.getContext('2d');
      
      // 薄い格子を描画
      ctx.strokeStyle = '#ddd';
      ctx.lineWidth = 1;
      
      // 縦線
      for (let x = 0; x < animationCanvas.width; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, animationCanvas.height);
        ctx.stroke();
      }
      
      // 横線
      for (let y = 0; y < animationCanvas.height; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(animationCanvas.width, y);
        ctx.stroke();
      }
      
      // 円を描画
      ctx.beginPath();
      ctx.arc(centerX, centerY, displayRadius, 0, 2 * Math.PI);
      ctx.fillStyle = 'rgba(0, 255, 0, 0.1)';
      ctx.fill();
      ctx.strokeStyle = 'green';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // 中心点を描画
      ctx.beginPath();
      ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
      ctx.fillStyle = 'black';
      ctx.fill();
      
      // 半径の線を描画
      ctx.beginPath();
      ctx.moveTo(centerX, centerY);
      ctx.lineTo(centerX + displayRadius, centerY);
      ctx.strokeStyle = 'green';
      ctx.lineWidth = 1;
      ctx.stroke();
      
      // 半径のラベル
      ctx.fillStyle = 'black';
      ctx.font = '16px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(`r = ${radius}`, centerX + displayRadius / 2, centerY - 10);
    }

    // 内接多角形を描画
    function drawInscribedPolygon(progress = 1) {
      if (!showInside) return;
      
      const ctx = animationCanvas.getContext('2d');
      const points = calculatePolygonPoints(sides, displayRadius, true);
      
      // 多角形全体を描画
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);
      for (let i = 1; i < points.length * progress; i++) {
        const index = Math.floor(i);
        const nextIndex = (index + 1) % points.length;
        const fraction = i - index;
        
        if (fraction === 0 || progress >= 1) {
          ctx.lineTo(points[index].x, points[index].y);
        } else {
          const x = points[index].x + (points[nextIndex].x - points[index].x) * fraction;
          const y = points[index].y + (points[nextIndex].y - points[index].y) * fraction;
          ctx.lineTo(x, y);
        }
      }
      ctx.closePath();
      ctx.fillStyle = 'rgba(0, 0, 255, 0.3)';
      ctx.fill();
      ctx.strokeStyle = 'blue';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    // 外接多角形を描画
    function drawCircumscribedPolygon(progress = 1) {
      if (!showOutside) return;
      
      const ctx = animationCanvas.getContext('2d');
      const points = calculatePolygonPoints(sides, displayRadius, false);
      
      // 多角形全体を描画
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);
      for (let i = 1; i < points.length * progress; i++) {
        const index = Math.floor(i);
        const nextIndex = (index + 1) % points.length;
        const fraction = i - index;
        
        if (fraction === 0 || progress >= 1) {
          ctx.lineTo(points[index].x, points[index].y);
        } else {
          const x = points[index].x + (points[nextIndex].x - points[index].x) * fraction;
          const y = points[index].y + (points[nextIndex].y - points[index].y) * fraction;
          ctx.lineTo(x, y);
        }
      }
      ctx.closePath();
      ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
      ctx.fill();
      ctx.strokeStyle = 'red';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    // 内接多角形の三角形を描画
    function drawInscribedTriangles(triangleIndex, progress = 1) {
      if (!showInside) return;
      
      const ctx = animationCanvas.getContext('2d');
      const points = calculatePolygonPoints(sides, displayRadius, true);
      
      // 完全な三角形を描画
      for (let i = 0; i < triangleIndex; i++) {
        const point = points[i];
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(point.x, point.y);
        ctx.lineTo(points[(i + 1) % sides].x, points[(i + 1) % sides].y);
        ctx.closePath();
        ctx.fillStyle = 'rgba(255, 165, 0, 0.5)';
        ctx.fill();
        ctx.strokeStyle = 'orange';
        ctx.lineWidth = 2;
        ctx.stroke();
      }
      
      // 途中の三角形を描画
      if (triangleIndex < sides && progress > 0) {
        const point = points[triangleIndex];
        const nextPoint = points[(triangleIndex + 1) % sides];
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(point.x, point.y);
        
        // 第3点への線を途中まで描画
        const x = point.x + (nextPoint.x - point.x) * progress;
        const y = point.y + (nextPoint.y - point.y) * progress;
        ctx.lineTo(x, y);
        
        ctx.closePath();
        ctx.fillStyle = 'rgba(255, 165, 0, 0.5)';
        ctx.fill();
        ctx.strokeStyle = 'orange';
        ctx.lineWidth = 2;
        ctx.stroke();
      }
    }

    // 外接多角形の三角形を描画
    function drawCircumscribedTriangles(triangleIndex, progress = 1) {
      if (!showOutside) return;
      
      const ctx = animationCanvas.getContext('2d');
      const points = calculatePolygonPoints(sides, displayRadius, false);
      
      // 完全な三角形を描画
      for (let i = 0; i < triangleIndex; i++) {
        const point = points[i];
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(point.x, point.y);
        ctx.lineTo(points[(i + 1) % sides].x, points[(i + 1) % sides].y);
        ctx.closePath();
        ctx.fillStyle = 'rgba(255, 165, 0, 0.5)';
        ctx.fill();
        ctx.strokeStyle = 'orange';
        ctx.lineWidth = 2;
        ctx.stroke();
      }
      
      // 途中の三角形を描画
      if (triangleIndex < sides && progress > 0) {
        const point = points[triangleIndex];
        const nextPoint = points[(triangleIndex + 1) % sides];
        
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(point.x, point.y);
        
        // 第3点への線を途中まで描画
        const x = point.x + (nextPoint.x - point.x) * progress;
        const y = point.y + (nextPoint.y - point.y) * progress;
        ctx.lineTo(x, y);
        
        ctx.closePath();
        ctx.fillStyle = 'rgba(255, 165, 0, 0.5)';
        ctx.fill();
        ctx.strokeStyle = 'orange';
        ctx.lineWidth = 2;
        ctx.stroke();
      }
    }

    // 基本の多角形を描画
    function drawBasePolygons() {
      clearCanvas();
      drawBackground();
      
      if (showInside) {
        drawInscribedPolygon();
      }
      
      if (showOutside) {
        drawCircumscribedPolygon();
      }
    }

    // 指定のアニメーションステップを描画
    function drawAnimationStep(step, progress = 1) {
      clearCanvas();
      drawBackground();
      
      if (step === 0) {
        // 最初のステップ：基本の多角形を描画
        if (showInside) {
          drawInscribedPolygon(progress);
        }
        if (showOutside) {
          drawCircumscribedPolygon(progress);
        }
        
        if (progress >= 1) {
          statusText.textContent = "まず、円のなかの形と円のそとの形をえがきます";
        } else {
          statusText.textContent = "多角形をえがいていきます...";
        }
      } else if (step === 1) {
        // 内接多角形の三角形分割を表示
        if (showInside) {
          drawInscribedPolygon();
        }
        if (showOutside) {
          drawCircumscribedPolygon();
        }
        
        let triangleIndex = Math.floor(progress * sides);
        let triangleProgress = (progress * sides) - triangleIndex;
        
        if (showInside) {
          drawInscribedTriangles(triangleIndex, triangleProgress);
        }
        
        if (progress >= 1) {
          statusText.textContent = "円のなかの形を三角形に分けました";
        } else {
          statusText.textContent = "円のなかの形を三角形に分けています...";
        }
      } else if (step === 2) {
        // 外接多角形の三角形分割を表示
        if (showInside) {
          drawInscribedPolygon();
          drawInscribedTriangles(sides, 1);
        }
        if (showOutside) {
          drawCircumscribedPolygon();
        }
        
        let triangleIndex = Math.floor(progress * sides);
        let triangleProgress = (progress * sides) - triangleIndex;
        
        if (showOutside) {
          drawCircumscribedTriangles(triangleIndex, triangleProgress);
        }
        
        if (progress >= 1) {
          statusText.textContent = "円のそとの形も三角形に分けました";
        } else {
          statusText.textContent = "円のそとの形を三角形に分けています...";
        }
      } else if (step === 3) {
        // 両方の三角形分割を表示（終了状態）
        if (showInside) {
          drawInscribedPolygon();
          drawInscribedTriangles(sides, 1);
        }
        if (showOutside) {
          drawCircumscribedPolygon();
          drawCircumscribedTriangles(sides, 1);
        }
        
        statusText.textContent = "すべての三角形に分けました。かどの数をふやすと、だんだん円に近づきます";
      }
      
      // ステップカウンターを更新
      updateStepCounter();
    }

    // アニメーションを開始
    function startAnimation() {
      if (animationInterval) {
        clearInterval(animationInterval);
      }
      
      const frameDelay = Math.max(10, 110 - (animationSpeed * 10)); // スピードに応じて調整
      
      animationInterval = setInterval(() => {
        animationFrame++;
        
        if (animationFrame > maxAnimationFrames) {
          animationFrame = 0;
          animationStep = (animationStep + 1) % totalSteps;
        }
        
        const progress = animationFrame / maxAnimationFrames;
        drawAnimationStep(animationStep, progress);
      }, frameDelay);
    }

    // アニメーションを一時停止
    function pauseAnimation() {
      if (animationInterval) {
        clearInterval(animationInterval);
        animationInterval = null;
      }
    }

    // アニメーションをリセット
    function resetAnimation() {
      pauseAnimation();
      animationFrame = 0;
      animationStep = 0;
      drawAnimationStep(0, 0);
    }

    // 次のステップへ
    function nextStep() {
      pauseAnimation();
      animationFrame = maxAnimationFrames;
      animationStep = (animationStep + 1) % totalSteps;
      drawAnimationStep(animationStep, 1);
    }

    // ステップカウンターを更新
    function updateStepCounter() {
      stepCounter.textContent = `ステップ ${animationStep + 1} / ${totalSteps}`;
    }

    // パラメーターを設定
    function setParameters() {
      radius = parseInt(radiusInput.value) || 10;
      sides = parseInt(sidesSelect.value);
      
      // 面積を計算
      calculateAreas();
      
      // 初期状態を描画
      pauseAnimation();
      animationStep = 0;
      animationFrame = 0;
      drawAnimationStep(0, 1);
      
      // 記録の表示を更新
      recordRadiusSpan.textContent = radius;
      updateRecordsDisplay();
    }

    // 表示モードを切り替え
    function toggleDisplayMode() {
      // 現在のステップを再描画
      drawAnimationStep(animationStep, animationFrame / maxAnimationFrames);
    }

    // 記録を追加
    function addRecord() {
      // 既存の記録があるか確認
      const existingIndex = records.findIndex(record => record.sides === sides && record.radius === radius);
      
      if (existingIndex !== -1) {
        // 既存の記録を更新
        records[existingIndex] = {
          radius,
          sides,
          inscribedArea,
          circumscribedArea,
          circleArea,
          diffInscribed: circleArea - inscribedArea,
          diffCircumscribed: circumscribedArea - circleArea
        };
      } else {
        // 新しい記録を追加
        records.push({
          radius,
          sides,
          inscribedArea,
          circumscribedArea,
          circleArea,
          diffInscribed: circleArea - inscribedArea,
          diffCircumscribed: circumscribedArea - circleArea
        });
      }
      
      // 記録の表示を更新
      updateRecordsDisplay();
      
      // 確認メッセージ
      alert(`R=${radius}、${sides}かくの結果を記録しました！`);
    }

    // 記録の表示を更新
    function updateRecordsDisplay() {
      // 現在の半径に合わせた記録をフィルター
      const currentRadiusRecords = records.filter(record => record.radius === radius);
      
      // かどの数でソート
      currentRadiusRecords.sort((a, b) => a.sides - b.sides);
      
      // 表を更新
      recordsTable.innerHTML = '';
      
      currentRadiusRecords.forEach(record => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${record.sides}かく</td>
          <td class="blue-text">${record.inscribedArea.toFixed(4)}</td>
          <td class="red-text">${record.circumscribedArea.toFixed(4)}</td>
          <td>${record.diffInscribed.toFixed(4)}</td>
          <td>${record.diffCircumscribed.toFixed(4)}</td>
        `;
        
        recordsTable.appendChild(row);
      });
      
      // グラフを更新
      drawRecordsGraph(currentRadiusRecords);
    }

    // 記録のグラフを描画
    function drawRecordsGraph(records) {
      const ctx = recordsGraph.getContext('2d');
      const width = recordsGraph.width;
      const height = recordsGraph.height;
      
      // キャンバスをクリア
      ctx.clearRect(0, 0, width, height);
      
      if (records.length === 0) {
        // 記録がない場合
        ctx.fillStyle = 'black';
        ctx.font = '20px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('まだ記録がありません。「けっかをきろくする」ボタンを押してください。', width / 2, height / 2);
        return;
      }
      
      // グラフのマージン
      const marginLeft = 60;
      const marginBottom = 40;
      const marginTop = 20;
      const marginRight = 20;
      const graphWidth = width - marginLeft - marginRight;
      const graphHeight = height - marginBottom - marginTop;
      
      // X軸とY軸を描画
      ctx.beginPath();
      ctx.moveTo(marginLeft, height - marginBottom);
      ctx.lineTo(width - marginRight, height - marginBottom); // X軸
      ctx.moveTo(marginLeft, height - marginBottom);
      ctx.lineTo(marginLeft, marginTop); // Y軸
      ctx.strokeStyle = 'black';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      // X軸ラベル
      ctx.fillStyle = 'black';
      ctx.font = '14px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('かどの数', width / 2, height - 10);
      
      // Y軸ラベル
      ctx.save();
      ctx.translate(15, height / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.textAlign = 'center';
      ctx.fillText('めんせき', 0, 0);
      ctx.restore();
      
      // 最大値を見つける
      let maxArea = 0;
      records.forEach(record => {
        maxArea = Math.max(maxArea, record.circumscribedArea);
      });
      maxArea = maxArea * 1.1; // 10%余裕を持たせる
      
      // X軸の目盛り
      const xStep = graphWidth / (Math.max(records.length - 1, 1));
      records.forEach((record, index) => {
        const x = marginLeft + index * xStep;
        
        // 目盛り線
        ctx.beginPath();
        ctx.moveTo(x, height - marginBottom);
        ctx.lineTo(x, height - marginBottom + 5);
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 1;
        ctx.stroke();
        
        // ラベル
        ctx.fillStyle = 'black';
        ctx.textAlign = 'center';
        ctx.fillText(record.sides.toString(), x, height - marginBottom + 20);
      });
      
      // Y軸の目盛り
      for (let i = 0; i <= 5; i++) {
        const y = height - marginBottom - (i * graphHeight / 5);
        const value = (i * maxArea / 5).toFixed(1);
        
        // 目盛り線
        ctx.beginPath();
        ctx.moveTo(marginLeft - 5, y);
        ctx.lineTo(marginLeft, y);
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 1;
        ctx.stroke();
        
        // ラベル
        ctx.fillStyle = 'black';
        ctx.textAlign = 'right';
        ctx.fillText(value, marginLeft - 10, y + 5);
      }
      
      // 円の面積の水平線
      if (records.length > 0) {
        const circleArea = records[0].circleArea;
        const y = height - marginBottom - (circleArea * graphHeight / maxArea);
        
        ctx.beginPath();
        ctx.moveTo(marginLeft, y);
        ctx.lineTo(width - marginRight, y);
        ctx.strokeStyle = 'green';
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // 円の面積ラベル
        ctx.fillStyle = 'green';
        ctx.textAlign = 'left';
        ctx.fillText(`円の面積: ${circleArea.toFixed(2)}`, marginLeft + 10, y - 5);
      }
      
      // 内接多角形の線
      if (records.length > 0) {
        ctx.beginPath();
        records.forEach((record, index) => {
          const x = marginLeft + index * xStep;
          const y = height - marginBottom - (record.inscribedArea * graphHeight / maxArea);
          
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        ctx.strokeStyle = 'blue';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // データポイント
        records.forEach((record, index) => {
          const x = marginLeft + index * xStep;
          const y = height - marginBottom - (record.inscribedArea * graphHeight / maxArea);
          
          ctx.beginPath();
          ctx.arc(x, y, 5, 0, 2 * Math.PI);
          ctx.fillStyle = 'blue';
          ctx.fill();
        });
      }
      
      // 外接多角形の線
      if (records.length > 0) {
        ctx.beginPath();
        records.forEach((record, index) => {
          const x = marginLeft + index * xStep;
          const y = height - marginBottom - (record.circumscribedArea * graphHeight / maxArea);
          
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        ctx.strokeStyle = 'red';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // データポイント
        records.forEach((record, index) => {
          const x = marginLeft + index * xStep;
          const y = height - marginBottom - (record.circumscribedArea * graphHeight / maxArea);
          
          ctx.beginPath();
          ctx.arc(x, y, 5, 0, 2 * Math.PI);
          ctx.fillStyle = 'red';
          ctx.fill();
        });
      }
      
      // 凡例
      const legendX = width - marginRight - 150;
      const legendY = marginTop + 20;
      
      // 凡例の背景
      ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
      ctx.fillRect(legendX, legendY, 150, 80);
      ctx.strokeStyle = 'black';
      ctx.lineWidth = 1;
      ctx.strokeRect(legendX, legendY, 150, 80);
      
      // 内接多角形の凡例
      ctx.beginPath();
      ctx.moveTo(legendX + 10, legendY + 20);
      ctx.lineTo(legendX + 40, legendY + 20);
      ctx.strokeStyle = 'blue';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(legendX + 25, legendY + 20, 5, 0, 2 * Math.PI);
      ctx.fillStyle = 'blue';
      ctx.fill();
      ctx.fillStyle = 'black';
      ctx.textAlign = 'left';
      ctx.fillText('円のなかの形', legendX + 50, legendY + 25);
      
      // 外接多角形の凡例
      ctx.beginPath();
      ctx.moveTo(legendX + 10, legendY + 50);
      ctx.lineTo(legendX + 40, legendY + 50);
      ctx.strokeStyle = 'red';
      ctx.lineWidth = 2;
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(legendX + 25, legendY + 50, 5, 0, 2 * Math.PI);
      ctx.fillStyle = 'red';
      ctx.fill();
      ctx.fillStyle = 'black';
      ctx.textAlign = 'left';
      ctx.fillText('円のそとの形', legendX + 50, legendY + 55);
      
      // 円の面積の凡例
      ctx.beginPath();
      ctx.moveTo(legendX + 10, legendY + 80);
      ctx.lineTo(legendX + 40, legendY + 80);
      ctx.strokeStyle = 'green';
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = 'black';
      ctx.textAlign = 'left';
      ctx.fillText('円の面積', legendX + 50, legendY + 85);
    }

    // スクリーンショットを作成
    function takeScreenshot() {
      // タブ切り替え：表のタブを表示するが、プリント時に両方表示されるようにする
      showTable();
      
      // 少し待ってからスクリーンショットを取る
      setTimeout(() => {
        // プリント用に一時的にグラフも表示
        tableContent.classList.add('active');
        graphContent.classList.add('active');
        
        window.print();
        
        // プリント後に元に戻す
        setTimeout(() => {
          if (tableTabButton.classList.contains('active')) {
            graphContent.classList.remove('active');
          } else {
            tableContent.classList.remove('active');
          }
        }, 1000);
        
        alert('ブラウザの印刷機能が起動します。PDFとして保存を選択すると画像として保存できます。');
      }, 300);
    }

    // タブ切り替え: 表を表示
    function showTable() {
      tableContent.classList.add('active');
      graphContent.classList.remove('active');
      tableTabButton.classList.add('active');
      graphTabButton.classList.remove('active');
    }

    // タブ切り替え: グラフを表示
    function showGraph() {
      tableContent.classList.remove('active');
      graphContent.classList.add('active');
      tableTabButton.classList.remove('active');
      graphTabButton.classList.add('active');
    }

    // アニメーション速度を更新
    function updateSpeed() {
      animationSpeed = parseInt(speedSlider.value);
      
      // 速度表示を更新
      let speedText;
      if (animationSpeed <= 3) {
        speedText = "ゆっくり";
      } else if (animationSpeed <= 7) {
        speedText = "ふつう";
      } else {
        speedText = "はやい";
      }
      speedValue.textContent = speedText;
      
      // アニメーション中なら再開
      if (animationInterval) {
        pauseAnimation();
        startAnimation();
      }
    }

    // イベントリスナー
    setParamsButton.addEventListener('click', setParameters);
    nextStepButton.addEventListener('click', nextStep);
    playAnimationButton.addEventListener('click', startAnimation);
    pauseAnimationButton.addEventListener('click', pauseAnimation);
    speedSlider.addEventListener('input', updateSpeed);
    
    toggleInsideButton.addEventListener('click', () => {
      showInside = !showInside;
      toggleInsideButton.classList.toggle('active');
      toggleDisplayMode();
    });
    
    toggleOutsideButton.addEventListener('click', () => {
      showOutside = !showOutside;
      toggleOutsideButton.classList.toggle('active');
      toggleDisplayMode();
    });
    
    addRecordButton.addEventListener('click', addRecord);
    
    tableTabButton.addEventListener('click', showTable);
    graphTabButton.addEventListener('click', showGraph);
    
    screenshotButton.addEventListener('click', takeScreenshot);
    
    showHelpButton.addEventListener('click', () => {
      alert('このアプリでは、円と多角形のかんけいをアニメーションでみることができるよ！\n\n'
          + '1. 円のおおきさを入れる\n'
          + '2. かどの数をえらぶ\n'
          + '3. せっていするボタンを押す\n'
          + '4. つぎへボタンでアニメーションのつぎのステップを見る\n'
          + '5. アニメーションさいせいボタンで自動的に進む\n'
          + '6. けっかをきろくするボタンを押すと、その結果を表とグラフに記録できる\n'
          + '7. いろいろなかどの数で試してみよう！\n'
          + '8. きろくをスクショするボタンで、けっかを画像として保存できるよ\n\n'
          + 'このアプリでは、円のなかの形と円のそとの形を三角形に分けて考えることができます。かどの数をふやすと、どんどん円に近づいていくよ！');
    });
    
    // 初期化
    window.addEventListener('load', () => {
      initSidesOptions();
      totalSteps = 4; // 全アニメーションステップ数
      calculateAreas();
      drawAnimationStep(0, 1);
      updateSpeed(); // 速度表示を初期化
    });
  </script>
</body>
</html>